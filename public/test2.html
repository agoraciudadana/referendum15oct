<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'/>
    <title>Refer&eacute;ndum 15-oct</title>
    <script src="javascripts/jquery.min.js"></script>
    <script src="javascripts/json2.js"></script>
    
    <script type="text/javascript" charset="utf-8">
        var timeout;
        var lastStatus = 'NONE';
        var restartApplet = false;
        var appletLoadedOnce = false;
        var appletCode = '<applet id="java_applet" code="org.agora.VotingApplet.class" archive="lib/apache-commons-codec-1.4.jar, lib/bcprov-1.45.jar, lib/verificatum.jar, lib/agora-applet.jar" width="0" height="0"></applet>';

        // This are some checks that are doing at startup
        if (!navigator.javaEnabled()) {
            setStatus("JAVA_DISABLED", "ERROR", ""); 
        } else if (!(/Firefox[\/\s](\d+\.\d+)/.test(navigator.userAgent))) {
            setStatus("NOT_USING_FIREFOX", "ERROR", "Unfortunately, only Mozilla Firefox is currently supported");
        } else {
            timeout = setTimeout("checkStatus()", 1000);
        }

        function checkStatus() {
            console.log("inside checkStatus" + ", appletLoadedOnce = " + appletLoadedOnce);
            // If applet is not loaded
            try {
                var applet = $('#java_applet').get(0);
                console.log("applet = " + applet);
                applet.getAppletInfo();
                if (!appletLoadedOnce) {
                    appletLoadedOnce = true;
                    setStatus("APPLET_LOAD", "first time applet is loaded", "version info = " + applet.getAppletInfo());
                }
            } catch (error) {
                // It might be still loading
                if (restartApplet) {
                    setStatus("RELOADING_JAVA_APPLET", "please wait...", "");
                    $('#java_applet_wrapper').html(appletCode);
                    restartApplet = false;
                    appletLoadedOnce = false;
                } else {
                    if (!appletLoadedOnce) {
                        setStatus("LOADING_JAVA_APPLET", "please wait...", "");
                    } else {
                        // Applet crashed/closed!

                        setStatus("JAVA_APPLET_CRASHED", "ERROR", "");
                    }
                }
            }
            // Set the timeout again
            timeout = setTimeout("checkStatus()", 2000);
        }

        String.prototype.startsWith = function(str) {
            return this.match("^" + str) == str;
        }

        function triggerAppletRestart() {
            restartApplet = true;
            var applet = $('#java_applet').get(0);
            applet.terminateApplet();
            $('#java_applet_wrapper').html("empty");
        }

        function async_exception(className, description) {
            // Note that async_exception function is synchrnously executed by
            // the applet, so we cannot directly call to any applet's function
            // directly; that's why instead of doing a direct call to
            // triggerAppletRestart(); we use setTimeout.

            if (className == "java.security.ProviderException"
                && description == "Initialization failed") {
                setStatus(className, description, "NO CARD READER");
                timeout = setTimeout("triggerAppletRestart()", 1);

            } else if (className == "java.security.KeyStoreException" &&
                description == "PKCS11 not found") {
                // No card inside the card reader
                setStatus(className, description, "NO CARD");
                timeout = setTimeout("triggerAppletRestart()", 1);

            } else if (className == "java.security.ProviderException" &&
                description == "sun.security.pkcs11.wrapper.PKCS11Exception: CKR_GENERAL_ERROR") {
                setStatus(className, description, "USER DID NOT WANT TO SIGN");
                timeout = setTimeout("triggerAppletRestart()", 1);

            } else if (className == "org.agora.VotingApplet$PinCancelledByUser") {
                setStatus(className, description, "ERROR IN THE SERVER SIDE");
                timeout = setTimeout("triggerAppletRestart()", 1);

            } else if (className == "org.agora.VotingApplet$BallotCastingError") {
                setStatus(className, description, "ERROR IN THE SERVER SIDE");

            } else if (className == "org.agora.VotingApplet$SignatureCertificateNotFoundError") {
                setStatus(className, description, "");
                timeout = setTimeout("triggerAppletRestart()", 1);

            } else if (className == "org.agora.VotingApplet$CertificateWithoutPrivateKeyError") {
                setStatus(className, description, "");
                timeout = setTimeout("triggerAppletRestart()", 1);

            } else if (className == "java.security.InvalidKeyException" &&
                description.startsWith("No installed provider supports this key:")) {
                setStatus(className, description, "INVALID KEY REMOVE DNIE AND INSERT AGAIN");
                timeout = setTimeout("triggerAppletRestart()", 1);

            } else if (className == "org.agora.VotingApplet$InitTimeoutError") {
                setStatus(className, description, "INIT TIMEOUT, REMOVE DNIE AND INSERT AGAIN");

            } else if (className == "org.agora.VotingApplet$PinTimeoutError") {
                setStatus(className, description, "VOTE TIMEOUT");
                timeout = setTimeout("triggerAppletRestart()", 1);

            } else if (className == "org.agora.VotingApplet$UserInputTimeoutError") {
                setStatus(className, description, "VOTE TIMEOUT");
                timeout = setTimeout("triggerAppletRestart()", 1);

            } else if (className == "org.agora.VotingApplet$LoadCardDataTimeoutError") {
                setStatus(className, description, "VOTE TIMEOUT");
                timeout = setTimeout("triggerAppletRestart()", 1);

            } else if (className == "org.agora.VotingApplet$SignatureTimeoutError") {
                setStatus(className, description, "VOTE TIMEOUT");
                timeout = setTimeout("triggerAppletRestart()", 1);

            } else if (className == "org.agora.VotingApplet$SendBallotsTimeoutError") {
                setStatus(className, description, "VOTE TIMEOUT");
                timeout = setTimeout("triggerAppletRestart()", 1);

            } else {
                setStatus(className, description, "Unknown error");
            }
        }
        function async_update(code, description) {
            setStatus(code, description, '');
        }

        function setStatus(code, message, customMessage) {
            lastStatusCode = code;
            var html = getCurrentTimeString() + " | " + code + ": " + message + "; "  + customMessage;
            $('#applet_info').html(html);
            $('#applet_log').html($('#applet_log').html() + html + "<br/>");
        }

        function getCurrentTimeString() {
            var currentTime = new Date()
            var milliseconds = currentTime.getTime() % 1000;
            var seconds = currentTime.getSeconds();
            var minutes = currentTime.getMinutes();
            var hours = currentTime.getHours();
            return hours + ":" + minutes + ":" + seconds + "." + milliseconds;
        }

      $(function(){

        $('form').submit(function(e) {
            var applet = $('#java_applet').get(0);
            e.preventDefault();
            var ballotArray = [];
            $('input:checked').map(function(){
                var vote =  $(this).val(); // id number of the option selected by the user
                var proposal = $(this).attr('name'); // proposal id number
                var publicKey = $('#p' + proposal + '_pk').val();
                ballotArray[ballotArray.length] = vote;
                ballotArray[ballotArray.length] = proposal;
                ballotArray[ballotArray.length] = publicKey;
            });
            console.log("ballot = " + ballotArray.join(','));
            applet.vote(ballotArray.join(','), location.protocol + "//" + document.domain + ":" + location.port);
            return false;
        });
      });
    </script>
    
    <style type="text/css" media="screen">
      .title {
        width: 250px;
        display: inline-block;
      }
      
      h1 {
        font-size:21px;
      }
      
      ul.options {
        display: inline-block;
      }
      
      .options li {
        list-style-type: none;
        display: inline-block;
        margin: 0px 10px;
      }
      
      applet {
        width: 0px;
        height: 5px;
        float: left;
      }
      
      #params {
        width: 100%;
        margin-top:20px;
      }
      
    </style>
  </head>
  <body>
    <h1>Refer&eacute;ndum 15 Oct</h1>
    <div id="java_applet_wrapper">
        <applet id="java_applet" code="org.agora.VotingApplet.class" archive="lib/apache-commons-codec-1.4.jar, lib/bcprov-1.45.jar, lib/verificatum.jar, lib/agora-applet.jar" width="0" height="0"></applet>
    </div>
    <form>
      <ol>
        <li>
          <span class='title'>Reforma del sistema electoral</span>
          <input type='hidden' id='p1_pk' value='00000000020000000002010000001a766572696669636174756d2e61726974686d2e505047726f7570000000000200000000010000000002010000001c766572696669636174756d2e61726974686d2e4d6f645047726f75700000000004010000008101d9f27f10e6a62b003160daea5bed498c3dc4fcbf5d4badf230ec7937cf171dc024acfee3a0064f8627319092868724b3afdd0127eafc2187f251da5d0ce61e1ed31fd33afa2edc53174fc19c3c08cc8672b85fc495003494ae78f108f050a5c1753a8a44f33f67e2a7f0b38613292550c84e7af73bb8e7575de384594a85f97b010000008100ecf93f887353158018b06d752df6a4c61ee27e5faea5d6f918763c9be78b8ee012567f71d00327c31398c84943439259d7ee8093f57e10c3f928ed2e86730f0f698fe99d7d176e298ba7e0ce1e046643395c2fe24a801a4a573c7884782852e0ba9d4522799fb3f153f859c3099492a864273d7b9ddc73abaef1c22ca542fcbd010000008101c83d911aeb75c21582a6cdce4a9f5b287b9948a4e0c9d6b82cd82e0a29a9dabb78bd0e724456082f8e67321e8e5e5bb8c894b38d46005d02363ec1ccff2c6875fb6b866eff128debc09e5b79c94392ece36d9add853fcf5e31c2363025f10bed7e4bae268433b97e07c81ff39e1a991bd2d8fd4177450ff1fb7fb2dbe7b2745101000000040000000100000000020100000004000000000100000004000000000000000002010000008101c83d911aeb75c21582a6cdce4a9f5b287b9948a4e0c9d6b82cd82e0a29a9dabb78bd0e724456082f8e67321e8e5e5bb8c894b38d46005d02363ec1ccff2c6875fb6b866eff128debc09e5b79c94392ece36d9add853fcf5e31c2363025f10bed7e4bae268433b97e07c81ff39e1a991bd2d8fd4177450ff1fb7fb2dbe7b274510100000081001309b55b9599670d198118dfefc956161fa298ceae2ef64735082e5c52c1d3bb67969096a972550671a6ed3e950fa67a23562b4c0b0bddfe316191af88ea9843179fe0ce2c079d3151ebdc90c6e132edf099e49c73f2cacf72a730f8b849a0d24fac3d3eb86d819ea45c6919141966a07f709add6cc2a09e919a8d3585438009' />
          <ul class='options'>
            <li>
              <label id='p1_si'>S&iacute;</label>
              <input type='radio' name='1' value='0' id='p1_si'/>
            </li>
            <li>
              <label id='p1_no'>No</label>
              <input type='radio' name='1' value='1' id='p1_no'/>
            </li>
            <li>
              <label id='p1_abs'>Abstenci&oacute;n</label>
              <input type='radio' name='1' value='2' id='p1_abs'/>
            </li>
          </ul>

        </li>
        <li>
          <span class='title'>Transparencia</span>
          <input type='hidden' id='p1_pk' value='00000000020000000002010000001a766572696669636174756d2e61726974686d2e505047726f7570000000000200000000010000000002010000001c766572696669636174756d2e61726974686d2e4d6f645047726f75700000000004010000008101d9f27f10e6a62b003160daea5bed498c3dc4fcbf5d4badf230ec7937cf171dc024acfee3a0064f8627319092868724b3afdd0127eafc2187f251da5d0ce61e1ed31fd33afa2edc53174fc19c3c08cc8672b85fc495003494ae78f108f050a5c1753a8a44f33f67e2a7f0b38613292550c84e7af73bb8e7575de384594a85f97b010000008100ecf93f887353158018b06d752df6a4c61ee27e5faea5d6f918763c9be78b8ee012567f71d00327c31398c84943439259d7ee8093f57e10c3f928ed2e86730f0f698fe99d7d176e298ba7e0ce1e046643395c2fe24a801a4a573c7884782852e0ba9d4522799fb3f153f859c3099492a864273d7b9ddc73abaef1c22ca542fcbd010000008101c83d911aeb75c21582a6cdce4a9f5b287b9948a4e0c9d6b82cd82e0a29a9dabb78bd0e724456082f8e67321e8e5e5bb8c894b38d46005d02363ec1ccff2c6875fb6b866eff128debc09e5b79c94392ece36d9add853fcf5e31c2363025f10bed7e4bae268433b97e07c81ff39e1a991bd2d8fd4177450ff1fb7fb2dbe7b2745101000000040000000100000000020100000004000000000100000004000000000000000002010000008101c83d911aeb75c21582a6cdce4a9f5b287b9948a4e0c9d6b82cd82e0a29a9dabb78bd0e724456082f8e67321e8e5e5bb8c894b38d46005d02363ec1ccff2c6875fb6b866eff128debc09e5b79c94392ece36d9add853fcf5e31c2363025f10bed7e4bae268433b97e07c81ff39e1a991bd2d8fd4177450ff1fb7fb2dbe7b274510100000081001309b55b9599670d198118dfefc956161fa298ceae2ef64735082e5c52c1d3bb67969096a972550671a6ed3e950fa67a23562b4c0b0bddfe316191af88ea9843179fe0ce2c079d3151ebdc90c6e132edf099e49c73f2cacf72a730f8b849a0d24fac3d3eb86d819ea45c6919141966a07f709add6cc2a09e919a8d3585438009' />
        
          <ul class='options'>
            <li>
              <label id='p2_si'>S&iacute;</label>
              <input type='radio' name='2' value='0' id='p2_si'/>
            </li>
            <li>
              <label id='p2_no'>No</label>
              <input type='radio' name='2' value='1' id='p2_no'/>
            </li>
            <li>
              <label id='p2_abs'>Abstenci&oacute;n</label>
              <input type='radio' name='2' value='2' id='p2_abs'/>
            </li>
          </ul>
        </li>
        <li>
          <span class='title'>Separaci&oacute;n de poderes</span>
          <input type='hidden' id='p1_pk' value='00000000020000000002010000001a766572696669636174756d2e61726974686d2e505047726f7570000000000200000000010000000002010000001c766572696669636174756d2e61726974686d2e4d6f645047726f75700000000004010000008101d9f27f10e6a62b003160daea5bed498c3dc4fcbf5d4badf230ec7937cf171dc024acfee3a0064f8627319092868724b3afdd0127eafc2187f251da5d0ce61e1ed31fd33afa2edc53174fc19c3c08cc8672b85fc495003494ae78f108f050a5c1753a8a44f33f67e2a7f0b38613292550c84e7af73bb8e7575de384594a85f97b010000008100ecf93f887353158018b06d752df6a4c61ee27e5faea5d6f918763c9be78b8ee012567f71d00327c31398c84943439259d7ee8093f57e10c3f928ed2e86730f0f698fe99d7d176e298ba7e0ce1e046643395c2fe24a801a4a573c7884782852e0ba9d4522799fb3f153f859c3099492a864273d7b9ddc73abaef1c22ca542fcbd010000008101c83d911aeb75c21582a6cdce4a9f5b287b9948a4e0c9d6b82cd82e0a29a9dabb78bd0e724456082f8e67321e8e5e5bb8c894b38d46005d02363ec1ccff2c6875fb6b866eff128debc09e5b79c94392ece36d9add853fcf5e31c2363025f10bed7e4bae268433b97e07c81ff39e1a991bd2d8fd4177450ff1fb7fb2dbe7b2745101000000040000000100000000020100000004000000000100000004000000000000000002010000008101c83d911aeb75c21582a6cdce4a9f5b287b9948a4e0c9d6b82cd82e0a29a9dabb78bd0e724456082f8e67321e8e5e5bb8c894b38d46005d02363ec1ccff2c6875fb6b866eff128debc09e5b79c94392ece36d9add853fcf5e31c2363025f10bed7e4bae268433b97e07c81ff39e1a991bd2d8fd4177450ff1fb7fb2dbe7b274510100000081001309b55b9599670d198118dfefc956161fa298ceae2ef64735082e5c52c1d3bb67969096a972550671a6ed3e950fa67a23562b4c0b0bddfe316191af88ea9843179fe0ce2c079d3151ebdc90c6e132edf099e49c73f2cacf72a730f8b849a0d24fac3d3eb86d819ea45c6919141966a07f709add6cc2a09e919a8d3585438009' />
        
          <ul class='options'>
            <li>
              <label id='p3_si'>S&iacute;</label>
              <input type='radio' name='3' value='0' id='p3_si'/>
            </li>
            <li>
              <label id='p3_no'>No</label>
              <input type='radio' name='3' value='1' id='p3_no'/>
            </li>
            <li>
              <label id='p3_abs'>Abstenci&oacute;n</label>
              <input type='radio' name='3' value='2' id='p3_abs'/>
            </li>
          </ul>
        </li>
        <li>
          <span class='title'>Una democracia m&aacute;s participativa</span>
          <input type='hidden' id='p1_pk' value='00000000020000000002010000001a766572696669636174756d2e61726974686d2e505047726f7570000000000200000000010000000002010000001c766572696669636174756d2e61726974686d2e4d6f645047726f75700000000004010000008101d9f27f10e6a62b003160daea5bed498c3dc4fcbf5d4badf230ec7937cf171dc024acfee3a0064f8627319092868724b3afdd0127eafc2187f251da5d0ce61e1ed31fd33afa2edc53174fc19c3c08cc8672b85fc495003494ae78f108f050a5c1753a8a44f33f67e2a7f0b38613292550c84e7af73bb8e7575de384594a85f97b010000008100ecf93f887353158018b06d752df6a4c61ee27e5faea5d6f918763c9be78b8ee012567f71d00327c31398c84943439259d7ee8093f57e10c3f928ed2e86730f0f698fe99d7d176e298ba7e0ce1e046643395c2fe24a801a4a573c7884782852e0ba9d4522799fb3f153f859c3099492a864273d7b9ddc73abaef1c22ca542fcbd010000008101c83d911aeb75c21582a6cdce4a9f5b287b9948a4e0c9d6b82cd82e0a29a9dabb78bd0e724456082f8e67321e8e5e5bb8c894b38d46005d02363ec1ccff2c6875fb6b866eff128debc09e5b79c94392ece36d9add853fcf5e31c2363025f10bed7e4bae268433b97e07c81ff39e1a991bd2d8fd4177450ff1fb7fb2dbe7b2745101000000040000000100000000020100000004000000000100000004000000000000000002010000008101c83d911aeb75c21582a6cdce4a9f5b287b9948a4e0c9d6b82cd82e0a29a9dabb78bd0e724456082f8e67321e8e5e5bb8c894b38d46005d02363ec1ccff2c6875fb6b866eff128debc09e5b79c94392ece36d9add853fcf5e31c2363025f10bed7e4bae268433b97e07c81ff39e1a991bd2d8fd4177450ff1fb7fb2dbe7b274510100000081001309b55b9599670d198118dfefc956161fa298ceae2ef64735082e5c52c1d3bb67969096a972550671a6ed3e950fa67a23562b4c0b0bddfe316191af88ea9843179fe0ce2c079d3151ebdc90c6e132edf099e49c73f2cacf72a730f8b849a0d24fac3d3eb86d819ea45c6919141966a07f709add6cc2a09e919a8d3585438009' />

          <ul class='options'>
            <li>
              <label id='p4_si'>S&iacute;</label>
              <input type='radio' name='4' value='0' id='p4_si'/>
            </li>
            <li>
              <label id='p4_no'>No</label>
              <input type='radio' name='4' value='1' id='p4_no'/>
            </li>
            <li>
              <label id='p4_abs'>Abstenci&oacute;n</label>
              <input type='radio' name='4' value='2' id='p4_abs'/>
            </li>
          </ul>
        </li>
        <li>
          <span class='title'>Econom&iacute;a responsable</span>
          <input type='hidden' id='p1_pk' value='00000000020000000002010000001a766572696669636174756d2e61726974686d2e505047726f7570000000000200000000010000000002010000001c766572696669636174756d2e61726974686d2e4d6f645047726f75700000000004010000008101d9f27f10e6a62b003160daea5bed498c3dc4fcbf5d4badf230ec7937cf171dc024acfee3a0064f8627319092868724b3afdd0127eafc2187f251da5d0ce61e1ed31fd33afa2edc53174fc19c3c08cc8672b85fc495003494ae78f108f050a5c1753a8a44f33f67e2a7f0b38613292550c84e7af73bb8e7575de384594a85f97b010000008100ecf93f887353158018b06d752df6a4c61ee27e5faea5d6f918763c9be78b8ee012567f71d00327c31398c84943439259d7ee8093f57e10c3f928ed2e86730f0f698fe99d7d176e298ba7e0ce1e046643395c2fe24a801a4a573c7884782852e0ba9d4522799fb3f153f859c3099492a864273d7b9ddc73abaef1c22ca542fcbd010000008101c83d911aeb75c21582a6cdce4a9f5b287b9948a4e0c9d6b82cd82e0a29a9dabb78bd0e724456082f8e67321e8e5e5bb8c894b38d46005d02363ec1ccff2c6875fb6b866eff128debc09e5b79c94392ece36d9add853fcf5e31c2363025f10bed7e4bae268433b97e07c81ff39e1a991bd2d8fd4177450ff1fb7fb2dbe7b2745101000000040000000100000000020100000004000000000100000004000000000000000002010000008101c83d911aeb75c21582a6cdce4a9f5b287b9948a4e0c9d6b82cd82e0a29a9dabb78bd0e724456082f8e67321e8e5e5bb8c894b38d46005d02363ec1ccff2c6875fb6b866eff128debc09e5b79c94392ece36d9add853fcf5e31c2363025f10bed7e4bae268433b97e07c81ff39e1a991bd2d8fd4177450ff1fb7fb2dbe7b274510100000081001309b55b9599670d198118dfefc956161fa298ceae2ef64735082e5c52c1d3bb67969096a972550671a6ed3e950fa67a23562b4c0b0bddfe316191af88ea9843179fe0ce2c079d3151ebdc90c6e132edf099e49c73f2cacf72a730f8b849a0d24fac3d3eb86d819ea45c6919141966a07f709add6cc2a09e919a8d3585438009' />
        
          <ul class='options'>
            <li>
              <label id='p5_si'>S&iacute;</label>
              <input type='radio' name='5' value='0' id='p5_si'/>
            </li>
            <li>
              <label id='p5_no'>No</label>
              <input type='radio' name='5' value='1' id='p5_no'/>
            </li>
            <li>
              <label id='p5_abs'>Abstenci&oacute;n</label>
              <input type='radio' name='5' value='2' id='p5_abs'/>
            </li>
          </ul>
        </li>
      </ol>
      
      <input type='submit' value='Vota!!!'/>

      <pre id='params'>
      </pre>

      <div style="border: 1px red; width: 100%; height: 50px" id="applet_info">
      ...
      </div>

      <div style="border: solid 1px red; width: 100%; height: 250px; overflow:scroll;" id="applet_log">
      ...
      </div>
    
    </form>
  </body>
</html>