<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'/>
    <title>Refer&eacute;ndum 15-oct</title>
    <script src="javascripts/jquery.min.js"></script>
    <script src="javascripts/json2.js"></script>
    
    <script type="text/javascript" charset="utf-8">
        var restartApplet = false;
        var appletLoadedOnce = false;
        var appletCode = '<applet id="java_applet" code="org.agora.VotingApplet.class" archive="lib/apache-commons-codec-1.4.jar, lib/bcprov-1.45.jar, lib/verificatum.jar, lib/agora-applet.jar" width="200" height="100"></applet>';

        // This are some checks that are doing at startup
        if (!navigator.javaEnabled()) {
            $('#applet_info').html("ERROR: JAVA IS DISABLED");
        } else if (!(/Firefox[\/\s](\d+\.\d+)/.test(navigator.userAgent))) {
            $('#applet_info').html("ERROR: NOT USING FIREFOX");
        } else {
            setTimeout("checkStatus()", 1000);
        }

        function checkStatus() {
            console.log("inside checkStatus" + ", appletLoadedOnce = " + appletLoadedOnce);
            // If applet is not loaded
            try {
                var applet = $('#java_applet').get(0);
                console.log("applet = " + applet);
                applet.getAppletInfo();
                if (!appletLoadedOnce) {
                    appletLoadedOnce = true;
                }
            } catch (error) {
                console.log("error..")
                // It might be still loading
                if (restartApplet) {
                    $('#applet_info').html("RE-Loading java applet, please wait..");
                    $('#java_applet_wrapper').html(appletCode);
                    restartApplet = false;
                    appletLoadedOnce = false;
                } else {
                    if (!appletLoadedOnce) {
                        $('#applet_info').html("Loading java applet, please wait..");
                    } else {
                        // Applet crashed/closed!
                        $('#applet_info').html("ERROR: JAVA APPLET CRASHED");
                    }
                }
            }
            // Set the timeout again
            setTimeout("checkStatus()", 2000);
        }

        String.prototype.startsWith = function(str) {
            return this.match("^" + str) == str;
        }

        function triggerAppletRestart() {
            restartApplet = true;
            var applet = $('#java_applet').get(0);
            applet.terminateApplet();
            $('#java_applet_wrapper').html("empty");
        }

        function async_exception(className, description) {
            // Note that async_exception function is synchrnously executed by
            // the applet, so we cannot directly call to any applet's function
            // directly; that's why instead of doing a direct call to
            // triggerAppletRestart(); we use setTimeout.
            if (className == "java.security.ProviderException"
                && description == "Initialization failed") {
                // No card reader
                // TODO: java applet seems to need to be restarted to work
                $('#applet_info').html("NO CARD READER " + className + ": " + description);
                setTimeout("triggerAppletRestart()", 1);

            } else if (className == "java.security.KeyStoreException" &&
                description == "PKCS11 not found") {
                // No card inside the card reader
                $('#applet_info').html("NO CARD " + className + ": " + description);
                setTimeout("triggerAppletRestart()", 1);

            } else if (className == "java.security.ProviderException" &&
                description == "sun.security.pkcs11.wrapper.PKCS11Exception: CKR_GENERAL_ERROR") {
                $('#applet_info').html("USER DID NOT WANT TO SIGN " + className + ": " + description);
                setTimeout("triggerAppletRestart()", 1);

            } else if (className == "org.agora.VotingApplet$PinCancelledByUser") {
                $('#applet_info').html("USER CANCELLED TO WRITE PIN" + className + ": " + description);
                setTimeout("triggerAppletRestart()", 1);

            } else if (className == "org.agora.VotingApplet$BallotCastingError") {
                $('#applet_info').html("ERROR IN THE SERVER SIDE" + className + ": " + description);

            } else if (className == "org.agora.VotingApplet$SignatureCertificateNotFoundError") {
                $('#applet_info').html("CERTIFICATE FOR THE SIGNATURE NOT FOUND" + className + ": " + description);
                setTimeout("triggerAppletRestart()", 1);

            } else if (className == "org.agora.VotingApplet$CertificateWithoutPrivateKeyError") {
                $('#applet_info').html("CERTIFICATE WITHOUT PRIVATE KEY" + className + ": " + description);
                setTimeout("triggerAppletRestart()", 1);

            } else if (className == "java.security.InvalidKeyException" &&
                description.startsWith("No installed provider supports this key:")) {
                // TODO: Java applet needs to be reestarted, applet does not allow
                // to be reused, apparently
                $('#applet_info').html("INVALID KEY " + className + ": " + description);
                setTimeout("triggerAppletRestart()", 1);

            } else if (className == "org.agora.VotingApplet$InitTimeoutError") {
                $('#applet_info').html("REMOVE DNIE AND INSERT AGAIN " + className + ": " + description);

            } else {
                $('#applet_info').html("Unknown error " + className + ": " + description);
            }
        }
        function async_update(code, description) {
            $('#applet_info').html(code + ": " + description);
        }
      $(function(){

        $('form').submit(function(e) {
            var applet = $('#java_applet').get(0);
            e.preventDefault();
            var ballotArray = [];
            $('input:checked').map(function(){
                var vote =  $(this).val(); // id number of the option selected by the user
                var propossal = $(this).attr('name'); // propossal id number
                ballotArray[ballotArray.length] = vote;
                ballotArray[ballotArray.length] = propossal;
            });
            console.log("ballot = " + ballotArray.join(','));
            applet.vote(ballotArray.join(','), location.protocol + "//" + document.domain + ":" + location.port);
            return false;
        });
      });
    </script>
    
    <style type="text/css" media="screen">
      .title {
        width: 250px;
        display: inline-block;
      }
      
      h1 {
        font-size:21px;
      }
      
      ul.options {
        display: inline-block;
      }
      
      .options li {
        list-style-type: none;
        display: inline-block;
        margin: 0px 10px;
      }
      
      applet {
        width: 200px;
        height: 50px;
        float: left;
      }
      
      #params {
        width: 100%;
        margin-top:20px;
      }
      
    </style>
  </head>
  <body>
    <h1>Refer&eacute;ndum 15 Oct</h1>
    <div id="java_applet_wrapper">
        <applet id="java_applet" code="org.agora.VotingApplet.class" archive="lib/apache-commons-codec-1.4.jar, lib/bcprov-1.45.jar, lib/verificatum.jar, lib/agora-applet.jar" width="200" height="100"></applet>
    </div>
    <form>
      <ol>
        <li>
          <span class='title'>Reforma del sistema electoral</span>
        
          <ul class='options'>
            <li>
              <label id='p1_si'>S&iacute;</label>
              <input type='radio' name='1' value='0' id='p1_si'/>
            </li>
            <li>
              <label id='p1_no'>No</label>
              <input type='radio' name='1' value='1' id='p1_no'/>
            </li>
            <li>
              <label id='p1_abs'>Abstenci&oacute;n</label>
              <input type='radio' name='1' value='2' id='p1_abs'/>
            </li>
          </ul>

        </li>
        <li>
          <span class='title'>Transparencia</span>
        
          <ul class='options'>
            <li>
              <label id='p2_si'>S&iacute;</label>
              <input type='radio' name='2' value='0' id='p2_si'/>
            </li>
            <li>
              <label id='p2_no'>No</label>
              <input type='radio' name='2' value='1' id='p2_no'/>
            </li>
            <li>
              <label id='p2_abs'>Abstenci&oacute;n</label>
              <input type='radio' name='2' value='2' id='p2_abs'/>
            </li>
          </ul>
        </li>
        <li>
          <span class='title'>Separaci&oacute;n de poderes</span>
        
          <ul class='options'>
            <li>
              <label id='p3_si'>S&iacute;</label>
              <input type='radio' name='3' value='0' id='p3_si'/>
            </li>
            <li>
              <label id='p3_no'>No</label>
              <input type='radio' name='3' value='1' id='p3_no'/>
            </li>
            <li>
              <label id='p3_abs'>Abstenci&oacute;n</label>
              <input type='radio' name='3' value='2' id='p3_abs'/>
            </li>
          </ul>
        </li>
        <li>
          <span class='title'>Una democracia m&aacute;s participativa</span>

          <ul class='options'>
            <li>
              <label id='p4_si'>S&iacute;</label>
              <input type='radio' name='4' value='0' id='p4_si'/>
            </li>
            <li>
              <label id='p4_no'>No</label>
              <input type='radio' name='4' value='1' id='p4_no'/>
            </li>
            <li>
              <label id='p4_abs'>Abstenci&oacute;n</label>
              <input type='radio' name='4' value='2' id='p4_abs'/>
            </li>
          </ul>
        </li>
        <li>
          <span class='title'>Econom&iacute;a responsable</span>
        
          <ul class='options'>
            <li>
              <label id='p5_si'>S&iacute;</label>
              <input type='radio' name='5' value='0' id='p5_si'/>
            </li>
            <li>
              <label id='p5_no'>No</label>
              <input type='radio' name='5' value='1' id='p5_no'/>
            </li>
            <li>
              <label id='p5_abs'>Abstenci&oacute;n</label>
              <input type='radio' name='5' value='2' id='p5_abs'/>
            </li>
          </ul>
        </li>
      </ol>
      
      <input type='submit' value='Vota!!!'/>

      <pre id='params'>
      </pre>

      <div style="border: 1px red; width: 500px; height: 100px" id="applet_info">
      aaaaaaaaaaaa
      </div>
    
    </form>
  </body>
</html>